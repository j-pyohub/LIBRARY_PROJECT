<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>예약 달력 (Bootstrap 적용)</title>

  <!-- ✅ Bootstrap 5.3.0 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet">

  <style>
    /* ✅ 테이블 전체 선 검정색 */
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }


    #container {
      margin-top: 20px;
    }

    .calendar-controls {
      display: flex;
      flex-direction: column; /* 위아래 배치 */
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* ✅ 날짜를 오른쪽 상단으로 정렬 */
    .month-view td {
      position: relative;
      height: 80px;
      vertical-align: top !important;
    }
    .month-view td strong {
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 0.9rem;
    }
    .month-view td small {
      display: block;
      margin-top: 22px;
      font-size: 0.75rem;
      color: #555;
    }

    /* ✅ 주간 / 일간 달력의 표 높이 축소 */
    .week-view td,
    .day-view td {
      height: 36px;
      padding: 4px 6px !important;
      font-size: 0.85rem;
      vertical-align: middle !important;
    }
  </style>
</head>

<body class="bg-body-tertiary">
<div class="container-fluid">
  <div class="row">

    <!-- 여기서 사이드바를 주입 -->
    <div id="sidebar-slot" class="col-2 p-0"></div>

    <!-- 메인 -->
    <main class="col-10 p-4">
  <div class="container py-4">
    <h2 class="text-center mb-4">예약 달력</h2>

    <div class="calendar-controls">
      <!-- ✅ 드롭다운 -->
      <div class="d-inline-flex align-items-center">
        <label for="viewSelect" class="me-2 mb-0 fw-bold">월/주/일 선택</label>
        <select id="viewSelect" class="form-select form-select-sm w-auto">
          <option value="month" selected>Month</option>
          <option value="week">Week</option>
          <option value="day">Day</option>
        </select>
      </div>

      <!-- ✅ 이전/다음 버튼 -->
      <div>
        <button id="prev" class="btn btn-outline-dark">◀</button>
        <span id="ym" class="fw-bold fs-5">—</span>
        <button id="next" class="btn btn-outline-dark">▶</button>
      </div>
    </div>

    <div id="container"></div>
  </div>
	</main>
		</div>
	</div>
	<script>
	  // sidebar.html을 불러와서 #sidebar-slot에 삽입
	  async function loadSidebar(activeKey) {
	    const slot = document.getElementById('sidebar-slot');
	    const resp = await fetch('./doctorSidebar.html'); // 경로는 프로젝트 구조에 맞게
	    const html = await resp.text();
	    slot.innerHTML = html;

	    // 활성 메뉴 표시 (data-route 값을 사용)
	    const current = slot.querySelector(`[data-route="${activeKey}"]`);
	    if (current) {
	      // 전부 초기화
	      slot.querySelectorAll('#sidebar-nav .nav-link').forEach(a=>{
	        a.classList.remove('active','bg-primary','text-white');
	        a.classList.add('text-dark');
	      });
	      // 현재만 활성
	      current.classList.add('active','bg-primary','text-white');
	      current.classList.remove('text-dark');
	    }
	  }

	  // 이 페이지의 활성 키만 바꿔주면 됨
	  loadSidebar('patientList');

  /* 예약 데이터 (예시) */
  const reservationEvents = {
    "2025-09-16": [
      { start: "09:00", end: "09:30", title: "고은님" },
      { start: "14:00", end: "14:30", title: "이수현" }
    ],
    "2025-09-15": [
      { start: "10:00", end: "11:00", title: "심박 검사" }
    ]
  };

  /* 전역 상태 */
  let viewMode = 'month'; 
  let viewDate = new Date();
  viewDate.setDate(1);

  function fmt(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,'0');
    const d = String(date.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function startOfWeekMonday(d) {
    const dt = new Date(d);
    const day = dt.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    dt.setDate(dt.getDate() + diff);
    dt.setHours(0,0,0,0);
    return dt;
  }
  function addDays(d, n) {
    const dt = new Date(d);
    dt.setDate(dt.getDate() + n);
    return dt;
  }

  const container = document.getElementById('container');
  const ymSpan = document.getElementById('ym');

  function render() {
    if (viewMode === 'month') renderMonth();
    else if (viewMode === 'week') renderWeek();
    else renderDay();
  }

  /* ✅ Month View (월요일 시작, 날짜 오른쪽 상단) */
  function renderMonth() {
    const year = viewDate.getFullYear();
    const month = viewDate.getMonth();
    ymSpan.textContent = `${year}년 ${month + 1}월`;

    let firstDay = new Date(year, month, 1).getDay(); // 0=일요일
    if (firstDay === 0) firstDay = 7; // 일요일을 7로
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const days = ['월', '화', '수', '목', '금', '토', '일'];

    let html = '<table class="table table-bordered text-center align-middle month-view"><thead><tr>';
    for (const d of days) html += `<th>${d}</th>`;
    html += '</tr></thead><tbody>';

    let day = 1;
    let started = false;

    for (let r = 0; r < 6 && day <= daysInMonth; r++) {
      html += '<tr>';
      for (let c = 1; c <= 7; c++) {
        if (!started && c < firstDay) {
          html += '<td></td>';
        } else if (day > daysInMonth) {
          html += '<td></td>';
        } else {
          const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const count = (reservationEvents[dateKey] || []).length;
          html += `<td><strong>${day}</strong><small>총 예약 ${count}건</small></td>`;
          day++;
          started = true;
        }
      }
      html += '</tr>';
    }

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /* ✅ Week View (예약 목록 표시로 변경) */
  function renderWeek() {
    const monday = startOfWeekMonday(viewDate);
    const weekDays = [];
    for (let i = 0; i < 7; i++) weekDays.push(addDays(monday, i));
    ymSpan.textContent = `${fmt(weekDays[0])} ~ ${fmt(weekDays[6])}`;

    const hours = [];
    for (let h = 7; h <= 19; h++) hours.push(h);

    let html = '<table class="table table-bordered text-center align-middle week-view"><thead><tr><th>시간</th>';
    for (let d of weekDays) {
      const dayLabel = d.toLocaleDateString('ko-KR', { weekday: 'short' });
      html += `<th>${dayLabel} (${d.getMonth() + 1}/${d.getDate()})</th>`;
    }
    html += '</tr></thead><tbody>';

    for (let h of hours) {
      html += '<tr>';
      html += `<td>${h}:00</td>`;
      for (let d of weekDays) {
        const key = fmt(d);
        const evs = (reservationEvents[key] || []).filter(e =>
          e.start.startsWith(String(h).padStart(2, '0'))
        );
        // ✅ 예약 목록 표시 (일간처럼)
        if (evs.length > 0) {
          html += `<td class="text-start">${evs.map(e => `<div>${e.start} - ${e.end} ${e.title}</div>`).join('')}</td>`;
        } else {
          html += `<td></td>`;
        }
      }
      html += '</tr>';
    }

    // ✅ 마지막 줄: 각 날짜별 총 예약 수
    html += '<tr>';
    html += `<td class="fw-bold bg-light">총 예약</td>`;
    for (let d of weekDays) {
      const key = fmt(d);
      const total = (reservationEvents[key] || []).length;
      html += `<td class="bg-light fw-bold">총 ${total}건</td>`;
    }
    html += '</tr>';

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /* ✅ Day View (그대로 유지) */
  function renderDay() {
    const key = fmt(viewDate);
    ymSpan.textContent = key;

    const hours = [];
    for (let h=7; h<=19; h++) hours.push(h);

    let html = '<table class="table table-bordered text-center align-middle day-view"><thead><tr><th>시간</th><th>예약</th></tr></thead><tbody>';
    for (let h of hours) {
      const evs = (reservationEvents[key]||[]).filter(e => e.start.startsWith(String(h).padStart(2,'0')));
      html += `<tr><td>${h}:00</td><td class="text-start">${evs.map(e=>`${e.start}-${e.end} ${e.title}`).join('<br>')}</td></tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /* ✅ 드롭다운 이벤트 */
  const viewSelect = document.getElementById('viewSelect');
  viewSelect.addEventListener('change', () => {
    viewMode = viewSelect.value;
    render();
  });

  /* ✅ 이전 / 다음 버튼 */
  document.getElementById('prev').onclick = ()=>{
    if (viewMode==='month') viewDate.setMonth(viewDate.getMonth()-1);
    else if (viewMode==='week') viewDate.setDate(viewDate.getDate()-7);
    else if (viewMode==='day') viewDate.setDate(viewDate.getDate()-1);
    render();
  };
  document.getElementById('next').onclick = ()=>{
    if (viewMode==='month') viewDate.setMonth(viewDate.getMonth()+1);
    else if (viewMode==='week') viewDate.setDate(viewDate.getDate()+7);
    else if (viewMode==='day') viewDate.setDate(viewDate.getDate()+1);
    render();
  };

  /* ✅ 최초 렌더 */
  render();
  </script>
</body>
</html>
