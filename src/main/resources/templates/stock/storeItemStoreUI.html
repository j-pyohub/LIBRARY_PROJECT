<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>재고 조회 : 직영점</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- 스타일은 head에만 배치 (본문 중간에 섞지 않음) -->
    <style>
        body{background:#f8f9fa}
        .layout-container{max-width:1500px;margin:0 auto}

        .store-item-table thead th{
            position:sticky;top:0;z-index:2;
            background:#e9ecef !important;color:#212529 !important;
            box-shadow:0 1px 0 rgba(0,0,0,.05);
        }
        .store-item-table td,.store-item-table th{font-size:.9rem}

        .text-qty{text-align:right;white-space:nowrap}
        .text-code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

        .btn-main{background:#FFEEAA;border-color:#FFEEAA;color:#000}
        .btn-main:hover{background:#f2da84;border-color:#f2da84;color:#000}

        .icon-btn{border:0;background:transparent;padding:4px;line-height:1}
        .icon-btn:focus{box-shadow:none}
        .limit-gear{cursor:pointer}

        .hint-note{font-size:.9rem;color:#6c757d}
        .hint-note .low{color:#b00020;font-weight:700}

        .position-relative{position:relative !important}
        #storeNoticeOverlay{
            position:absolute;inset:0;backdrop-filter:blur(3px);
            background:rgba(255,255,255,.6);display:none;align-items:center;justify-content:center;z-index:5;
        }
        #storeNoticeOverlay .overlay-card{
            text-align:center;background:#ffffffdd;padding:28px 36px;border-radius:12px;
            box-shadow:0 4px 14px rgba(0,0,0,.12)
        }

        .w-search{max-width:420px}
        #storeSearchModal .modal-body._hideUntilReady { visibility: hidden; }

        /* 직영점 입력 + 버튼 한 줄 고정 */
        .stock-storebar { white-space: nowrap; }
        .w-220 { width: 220px; }
        .form-control.w-auto { min-width: 0; }
        @media (max-width: 576px) { .w-220 { width: 180px; } }

        /* 메인 테이블 첫 그리기 깜빡임 방지 */
        ._mainHideUntilReady { visibility: hidden; }
    </style>
</head>
<body>
<!-- 직영점 헤더 사용 -->
<header th:replace="fragments/toolBarStore :: toolBarStore"></header>

<div class="layout-container py-4 px-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <h3 class="fw-bold mb-0">재고 조회 : 직영점</h3>
        <div class="hint-note">하한선 미만: <span class="low">빨간 굵은 글씨</span></div>
    </div>

    <!-- 검색 바 -->
    <div class="card p-3 mb-3 shadow-sm border-0">
        <div class="row g-2 align-items-center">
            <div class="col-auto fw-bold">카테고리</div>
            <div class="col-6 col-md-2">
                <select id="categorySelect" class="form-select form-select-sm">
                    <option value="">전체</option><option>도우</option><option>소스</option><option>치즈</option>
                    <option>육류</option><option>야채</option><option>사이드</option><option>음료</option>
                </select>
            </div>

            <div class="col-6 col-md-2">
                <select id="searchTypeSelect" class="form-select form-select-sm">
                    <option value="ITEM_NAME">품목명</option>
                    <option value="ITEM_CODE">품목코드</option>
                </select>
            </div>

            <div class="col-12 col-md-5">
                <div class="input-group input-group-sm w-search">
                    <input id="searchKeyword" class="form-control" placeholder="검색어 입력">
                    <button class="btn btn-main" id="btnSearchExec">조회</button>
                    <button class="btn btn-outline-secondary" id="btnResetFilter">초기화</button>
                </div>
            </div>

            <div class="col d-flex justify-content-end align-items-center gap-2 flex-nowrap stock-storebar">
                <span class="fw-bold small">직영점</span>
                <input id="storeSearchKeyword" class="form-control form-control-sm w-auto w-220" placeholder="직영점명">
                <button type="button" class="btn btn-sm btn-main px-3" id="btnOpenStoreSearch">검색</button>
            </div>
        </div>
    </div>

    <!-- 메인 테이블 -->
    <div class="card shadow-sm border-0 position-relative">
        <div id="storeNoticeOverlay" class="d-flex">
            <div class="overlay-card">
                <i class="bi bi-shop fs-1 mb-2"></i>
                <div class="fw-bold">먼저 직영점을 선택해주세요</div>
                <div class="text-muted small">재고 목록은 직영점 선택 후 확인할 수 있어요.</div>
            </div>
        </div>

        <div class="card-body p-0 _mainHideUntilReady">
            <div class="table-responsive">
                <table class="table align-middle mb-0 store-item-table bg-white">
                    <thead>
                    <tr class="table-light">
                        <th>직영점</th>
                        <th>품목코드</th>
                        <th>품목명</th>
                        <th>카테고리</th>
                        <th class="text-qty">하한선</th>
                        <th class="text-qty">현재 재고</th>
                        <th class="text-center">액션</th>
                    </tr>
                    </thead>
                    <tbody id="stockTableBody">
                    <!-- ★ 서버 바인딩 영역 (data-* 속성 유지) -->
                    <tr data-itemno="1" data-storename="가산점" data-itemname="도우 M 230g(레귤러)" data-category="도우" data-currentqty="26" data-unit="ea" data-limit="40" data-itemcode="DOUGH-M-230G">
                        <td>가산점</td><td class="text-code">DOUGH-M-230G</td><td>도우 M 230g(레귤러)</td><td>도우</td>
                        <td class="text-qty">40 ea <button class="icon-btn" onclick="openLimitModal(this)" title="하한선 설정"><i class="bi bi-gear limit-gear"></i></button></td>
                        <td class="text-qty">26 ea</td>
                        <td class="text-center">
                            <button type="button" class="icon-btn detail-btn" title="상세보기"><i class="bi bi-file-earmark-text"></i></button>
                            <button type="button" class="icon-btn dispose-btn" title="폐기 등록" onclick="openDisposeModal(this)"><i class="bi bi-trash3"></i></button>
                        </td>
                    </tr>
                    <!-- 필요 행 계속… -->
                    </tbody>
                </table>
            </div>

            <!-- 메인 테이블 페이지네이션 -->
            <nav class="mt-2 mb-2">
                <ul class="pagination justify-content-center" id="mainPager"><!-- JS 생성 --></ul>
            </nav>
        </div>
    </div>
</div>

<!-- ===== 모달 프래그먼트: 수정 없이 그대로 사용 ===== -->
<div th:replace="fragments/modalStoreSearch :: modalStoreSearch"></div>
<div th:replace="fragments/modalLimit :: modalLimit"></div>
<div th:replace="fragments/modalDispose :: modalDispose"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* =========================
       공통 상태
    ========================= */
    let limitModalInstance = null;
    let storeSearchModalInstance = null;

    /* 메인 테이블 페이지네이션 */
    const TABLE_ROWS_PER_PAGE = 5;
    let $mainAllRows = $();      // 전체 행
    let $mainFilteredRows = $(); // 필터 후 행
    let mainTotalPages = 1;
    let mainCurrentPage = 1;

    /* 직영점 모달 페이지네이션 */
    const STORE_ROWS_PER_PAGE = 5;
    let $allStoreRows = $();
    let $filteredStoreRows = $();
    let storeTotalPages = 1;
    let storeCurrentPage = 1;

    /* 하한선 환산 예시 */
    const LIMIT_CONVERT_STOCK = 50;

    /* =========================
       표시/상태 유틸
    ========================= */
    function markLowRows(){
        $('#stockTableBody tr').each(function(){
            const cur = Number($(this).data('currentqty')) || 0;
            const lim = Number($(this).data('limit')) || 0;
            const $cell = $(this).children().eq(5);
            if(cur < lim){ $cell.addClass('text-danger fw-bold'); }
            else{ $cell.removeClass('text-danger fw-bold'); }
        });
    }

    function applyStoreVisibility(){
        const v = $.trim($('#storeSearchKeyword').val());
        const $ov = $('#storeNoticeOverlay');
        if(v){ $ov.removeClass('d-flex').addClass('d-none'); }
        else { $ov.removeClass('d-none').addClass('d-flex'); }
    }

    /* =========================
       하한선 모달 (값 바인딩만)
    ========================= */
    function openLimitModal(el){
        const $row = $(el).closest('tr');
        const storeName = $row.data('storename') || '';
        const itemName  = $row.data('itemname') || '';
        const limit     = $row.data('limit')     || 0;
        const unit      = $row.data('unit')      || 'ea';

        $('#limitStoreName').text(storeName);
        $('#limitItemName').text(itemName);
        $('#limitCurrentText').text(limit + ' ' + unit);
        $('#limitNew').val('');
        $('#limitUnit2').text(unit);
        $('#limitUseSupply').prop('checked', false);
        $('#limitSupplyCount').prop('disabled', true).val('');
        $('#limitSupplyUnit').text('box');
        $('#limitConvertInfo').text('※ 1 box = ' + LIMIT_CONVERT_STOCK + ' ' + unit + ' (예시)');

        if(!limitModalInstance){
            limitModalInstance = new bootstrap.Modal(document.getElementById('limitModal'));
        }
        limitModalInstance.show();
    }

    /* =========================
       폐기 모달 (프래그먼트 완성본 사용)
    ========================= */
    function openDisposeModal(el){
        const $row = $(el).closest('tr');
        const name = $row.data('itemname') || '';
        const cur  = Number($row.data('currentqty')) || 0;
        const unit = $row.data('unit') || 'ea';

        $('#disposeItemName').text(name);
        $('#disposeCurrentText').text(cur + ' ' + unit);
        $('#disposeUnit').text(unit);
        $('#disposeQuantity').val('');
        $('#disposeReason').val('');

        if(!window._disposeModalInstance){
            window._disposeModalInstance = new bootstrap.Modal(document.getElementById('disposeModal'));
        }
        window._disposeModalInstance.show();
    }

    /* =========================
       메인 테이블: 필터 & 페이지네이션(5개)
    ========================= */
    function snapshotMainRows(){ $mainAllRows = $('#stockTableBody tr'); }

    function applyMainFilter(){
        const cat  = $('#categorySelect').val();      // "" | 카테고리
        const type = $('#searchTypeSelect').val();    // ITEM_NAME | ITEM_CODE
        const kw   = ($('#searchKeyword').val()||'').trim();

        $mainFilteredRows = $mainAllRows.filter(function(){
            const $tr = $(this);

            // 카테고리
            const rowCat = ($tr.data('category') || '').toString();
            if(cat && rowCat !== cat) return false;

            if(!kw) return true;

            if(type === 'ITEM_NAME'){
                const name = ($tr.data('itemname') || '').toString();
                return name.indexOf(kw) !== -1;
            } else {
                const code = ($tr.data('itemcode') || '').toString();
                return code.indexOf(kw) !== -1;
            }
        });
    }

    function buildMainPager(){
        const total = $mainFilteredRows.length;
        mainTotalPages = Math.max(1, Math.ceil(total / TABLE_ROWS_PER_PAGE));

        const $pager = $('#mainPager').empty();
        $pager.append(li('first','&laquo;'));
        $pager.append(li('prev','&lt;'));
        for(let i=1;i<=mainTotalPages;i++){ $pager.append(li(String(i), String(i))); }
        $pager.append(li('next','&gt;'));
        $pager.append(li('last','&raquo;'));

        function li(data,text){
            return $('<li class="page-item"><a class="page-link" href="#"></a></li>')
                .find('a').attr('data-page', data).html(text).end();
        }
    }

    function showMainPage(page){
        mainCurrentPage = page;
        $mainAllRows.hide();
        const s = (page - 1) * TABLE_ROWS_PER_PAGE;
        const e = s + TABLE_ROWS_PER_PAGE;
        $mainFilteredRows.slice(s, e).show();
    }

    function paintMainPager(){
        const $pager = $('#mainPager');
        $pager.find('.page-item').removeClass('active disabled');
        $pager.find(`a[data-page="${mainCurrentPage}"]`).parent().addClass('active');
        if(mainCurrentPage === 1){
            disable('first'); disable('prev');
        }
        if(mainCurrentPage === mainTotalPages){
            disable('last'); disable('next');
        }
        function disable(key){ $pager.find(`a[data-page="${key}"]`).parent().addClass('disabled'); }
    }

    function refreshMainTable(){
        snapshotMainRows();
        applyMainFilter();
        buildMainPager();
        showMainPage(1);
        paintMainPager();
        markLowRows();
    }

    /* =========================
       직영점 모달: 페이징(5개) + 깜빡임 제거
    ========================= */
    function snapshotAllStoreRows(){
        $allStoreRows = $('#storeSearchTableBody tr');
        $allStoreRows.hide();
    }
    function applyStoreFilter(keyword){
        const kw = (keyword||'').trim();
        if(!kw){
            $filteredStoreRows = $allStoreRows;
        }else{
            $filteredStoreRows = $allStoreRows.filter(function(){
                const name = $(this).find('td').first().text();
                return name.indexOf(kw) !== -1;
            });
        }
        $allStoreRows.not($filteredStoreRows).hide();
    }
    function buildStorePager(){
        const total = $filteredStoreRows.length;
        storeTotalPages = Math.max(1, Math.ceil(total / STORE_ROWS_PER_PAGE));
        const $pager = $('#storePager').empty();
        $pager.append(li('first','&laquo;'));
        $pager.append(li('prev','&lt;'));
        for(let i=1;i<=storeTotalPages;i++){ $pager.append(li(String(i), String(i))); }
        $pager.append(li('next','&gt;'));
        $pager.append(li('last','&raquo;'));
        function li(data,text){
            return $('<li class="page-item"><a class="page-link" href="#"></a></li>')
                .find('a').attr('data-page', data).html(text).end();
        }
    }
    function showStorePage(page){
        storeCurrentPage = page;
        $allStoreRows.hide();
        const s = (page - 1) * STORE_ROWS_PER_PAGE;
        const e = s + STORE_ROWS_PER_PAGE;
        $filteredStoreRows.slice(s, e).show();
    }
    function paintStorePager(){
        const $pager = $('#storePager');
        $pager.find('.page-item').removeClass('active disabled');
        $pager.find(`a[data-page="${storeCurrentPage}"]`).parent().addClass('active');
        if(storeCurrentPage === 1){
            disable('first'); disable('prev');
        }
        if(storeCurrentPage === storeTotalPages){
            disable('last'); disable('next');
        }
        function disable(key){ $pager.find(`a[data-page="${key}"]`).parent().addClass('disabled'); }
    }
    function prepareStoreModalFirstView(){
        $('#storeSearchModal .modal-body').addClass('_hideUntilReady');
        snapshotAllStoreRows();
        applyStoreFilter($('#storeSearchInput').val() || '');
        buildStorePager(); showStorePage(1); paintStorePager();
        requestAnimationFrame(()=> $('#storeSearchModal .modal-body').removeClass('_hideUntilReady'));
    }

    /* =========================
       이벤트 바인딩
    ========================= */
    $(function(){
        // 메인: 첫 화면 깜빡임 방지 — 계산 먼저 하고 보이기
        refreshMainTable();
        $('.card-body._mainHideUntilReady').css('visibility','visible');

        applyStoreVisibility();

        // 상세보기 (라우팅만 연결 예시)
        $(document).on('click', '.detail-btn', function(){
            window.location.href = '../item/itemDetailUI.html';
        });

        // 조회 → 메인 필터(5개 페이징 유지)
        $('#btnSearchExec').on('click', function(){ refreshMainTable(); });

        // 초기화(직영점 값은 유지)
        $('#btnResetFilter').on('click', function(){
            $('#categorySelect').val('');
            $('#searchTypeSelect').val('ITEM_NAME');
            $('#searchKeyword').val('');
            refreshMainTable();
        });

        // 메인 페이지네이션
        $(document).on('click', '#mainPager a.page-link', function(e){
            e.preventDefault();
            const act = $(this).data('page');
            const $li = $(this).parent();
            if($li.hasClass('disabled') || $li.hasClass('active')) return;

            if(act === 'first') showMainPage(1);
            else if(act === 'prev') showMainPage(Math.max(1, mainCurrentPage - 1));
            else if(act === 'next') showMainPage(Math.min(mainTotalPages, mainCurrentPage + 1));
            else if(act === 'last') showMainPage(mainTotalPages);
            else {
                const n = parseInt(act, 10);
                if(!isNaN(n)) showMainPage(n);
            }
            paintMainPager();
        });

        // 직영점 모달 열기 (프래그먼트 사용)
        $('#btnOpenStoreSearch').on('click', function(){
            if(!storeSearchModalInstance){
                storeSearchModalInstance = new bootstrap.Modal(document.getElementById('storeSearchModal'));
            }
            $('#storeSearchInput').val($('#storeSearchKeyword').val() || '');
            prepareStoreModalFirstView();
            storeSearchModalInstance.show();
        });

        // 모달 내부: 검색/초기화
        $(document).on('click', '#btnSearchStoreExec', function(){
            snapshotAllStoreRows();
            applyStoreFilter($('#storeSearchInput').val());
            buildStorePager(); showStorePage(1); paintStorePager();
        });
        $(document).on('click', '#btnSearchStoreReset', function(){
            $('#storeSearchInput').val('');
            snapshotAllStoreRows();
            applyStoreFilter('');
            buildStorePager(); showStorePage(1); paintStorePager();
        });

        // 모달 내부: 페이지네이션
        $(document).on('click', '#storePager a.page-link', function(e){
            e.preventDefault();
            const act = $(this).data('page');
            const $li = $(this).parent();
            if($li.hasClass('disabled') || $li.hasClass('active')) return;

            if(act === 'first') showStorePage(1);
            else if(act === 'prev') showStorePage(Math.max(1, storeCurrentPage - 1));
            else if(act === 'next') showStorePage(Math.min(storeTotalPages, storeCurrentPage + 1));
            else if(act === 'last') showStorePage(storeTotalPages);
            else {
                const n = parseInt(act, 10);
                if(!isNaN(n)) showStorePage(n);
            }
            paintStorePager();
        });

        // 모달: 직영점 선택 → 오버레이 해제 + 닫기
        $(document).on('click', '.btn-select-store', function(){
            const store = $(this).data('store') || '';
            $('#storeSearchKeyword').val(store).trigger('input');
            applyStoreVisibility();
            storeSearchModalInstance?.hide();
        });

        // 메인 인풋 변경 시 오버레이 동기화
        $('#storeSearchKeyword').on('input change', applyStoreVisibility);
    });
</script>
</body>
</html>
