<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>매출관리 SPA (직영점)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- 공통 유틸 -->
  <script src="/js/util.js"></script>

  <style>
    body { background-color:#fdfdfd; }
    .max-1500 { max-width:1500px; margin:0 auto; }
    .kpi-card { background:#fff; border:1px solid #ccc; border-radius:10px; padding:18px; text-align:center; }
    .kpi-title { font-size:14px; }
    .kpi-value { font-size:22px; font-weight:600; }
    .section-box { background:#fff; border:1px solid #ddd; border-radius:10px; padding:20px; }
    .w-150 { width:150px; }
    .w-120 { width:120px; }
    .detail-btn { width:24px; cursor:pointer; }
    #listPage { display:none; }
  </style>
</head>

<body class="p-2">

<div class="border border-primary p-2 max-1500">

  <!-- 보기 버튼 -->
  <div class="mt-3 px-2">
    <div class="d-flex align-items-center mb-2">
      <span class="me-2">보기</span>
      <div class="btn-group">
        <button id="chartBtn" class="btn btn-warning btn-sm">차트</button>
        <button id="listBtn" class="btn btn-outline-secondary btn-sm">목록</button>
      </div>
    </div>
  </div>

  <!-- ===================================================================
       CHART PAGE
  =================================================================== -->
  <div id="chartPage">

    <!-- 조회 기준 + 조회기간 -->
    <div class="d-flex align-items-center flex-wrap gap-3 mb-3 px-2">

      <!-- 라디오 -->
      <div>
        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="day" class="form-check-input">
          <span>일별</span>
        </label>

        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="week" class="form-check-input">
          <span>주별</span>
        </label>

        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="month" class="form-check-input" checked>
          <span>월별</span>
        </label>

        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="year" class="form-check-input">
          <span>연별</span>
        </label>
      </div>

      <!-- 조회기간 -->
      <div class="d-flex align-items-center gap-2">
        <span class="fw-semibold">조회기간</span>

        <div id="periodInputs" class="d-flex align-items-center gap-2">
          <input id="startInput" type="month" class="form-control form-control-sm w-150">
          <span>~</span>
          <input id="endInput" type="month" class="form-control form-control-sm w-150">
        </div>

        <button id="getSalesBtn" class="btn btn-primary btn-sm">조회</button>
      </div>

    </div>

    <!-- KPI -->
    <div class="row g-3 mb-3 px-2">
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">전체 매출</div>
          <div class="kpi-value" id="kpi-totalSales">-</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">총 판매 수량</div>
          <div class="kpi-value" id="kpi-totalMenu">-</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">평균 단가</div>
          <div class="kpi-value" id="kpi-avgPrice">-</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title kpi-compare">전주 대비 매출 증가</div>
          <div class="kpi-value" id="kpi-growth">-</div>
        </div>
      </div>
    </div>

    <!-- 메인 차트 -->
    <div class="section-box mx-2 mb-4">
      <h6 class="fw-bold mb-3">전체 매출 추이</h6>
      <canvas id="mainChart" height="90"></canvas>
    </div>

    <!-- 서브 차트 (본사와 동일) -->
    <div class="row g-3 mb-3 px-2">

      <div class="col-md-6">
        <div class="section-box">
          <h6 class="fw-bold mb-3">최근 30일 지점별 매출 TOP 5</h6>
          <canvas id="storeSalesTop5Chart" height="130"></canvas>
        </div>
      </div>

      <div class="col-md-6">
        <div class="section-box">
          <h6 class="fw-bold mb-3">최근 30일 메뉴별 매출 비중</h6>
          <canvas id="menuCountChart" height="130"></canvas>
        </div>
      </div>

    </div>

  </div>


  <!-- ===================================================================
       LIST PAGE (현재 미사용)
  =================================================================== -->
  <div id="listPage"></div>

</div>


<!-- ===================================================================
       SCRIPT
=================================================================== -->
<script>

  /* === 화면 전환 === */
  $("#chartBtn").on("click", ()=>showChart());
  $("#listBtn").on("click", ()=>showList());

  function updateModeButtons(mode){
    $("#chartBtn").toggleClass("btn-warning", mode==="chart")
            .toggleClass("btn-outline-secondary", mode!=="chart");
    $("#listBtn").toggleClass("btn-warning", mode==="list")
            .toggleClass("btn-outline-secondary", mode!=="list");
  }

  function showChart(){ $("#chartPage").show(); $("#listPage").hide(); updateModeButtons("chart"); }
  function showList(){ $("#chartPage").hide(); $("#listPage").show(); updateModeButtons("list"); }


  /* === 조회기간 input === */
  function updatePeriodInputs(type){
    const box = $("#periodInputs");
    const tpl = {
      day:`<input id="startInput" type="date" class="form-control form-control-sm w-150">
           <span>~</span>
           <input id="endInput" type="date" class="form-control form-control-sm w-150">`,
      week:`<input id="startInput" type="week" class="form-control form-control-sm w-150">
            <span>~</span>
            <input id="endInput" type="week" class="form-control form-control-sm w-150">`,
      month:`<input id="startInput" type="month" class="form-control form-control-sm w-150">
             <span>~</span>
             <input id="endInput" type="month" class="form-control form-control-sm w-150">`,
      year:`<input id="startInput" type="number" class="form-control form-control-sm w-120" placeholder="연도">
            <span>~</span>
            <input id="endInput" type="number" class="form-control form-control-sm w-120" placeholder="연도">`
    };
    box.html(tpl[type]);
  }

  $("input[name='period']").on("change", function(){
    updatePeriodInputs($(this).attr("id"));
  });


  /* === 메인 차트 === */
  let mainChart;

  function createMainChart(labels, values){
    const ctx = $("#mainChart")[0].getContext("2d");
    if(mainChart) mainChart.destroy();

    mainChart = new Chart(ctx,{
      type:"line",
      data:{
        labels,
        datasets:[{
          label:"매출액",
          data:values,
          borderColor:"#007bff",
          backgroundColor:"rgba(0,123,255,0.15)",
          borderWidth:2,
          fill:true
        }]
      }
    });
  }

  function loadTrend(type, start, end){
    const url = `/store/salesChart?startDate=${start}&endDate=${end}&type=${type}`;
    fetchUtil(url, data => {
      console.log("메인차트 응답:", data);
      createMainChart(data.labels, data.values);
    });
  }


  /* === 조회 버튼 === */
  $("#getSalesBtn").on("click", function(){
    const type = $("input[name='period']:checked").attr("id");
    const s = $("#startInput").val();
    const e = $("#endInput").val();

    if(!s || !e){
      alert("조회기간을 입력하세요.");
      return;
    }

    loadTrend(type, s, e);
  });


  /* === TOP5 === */
  function loadTop5(){
    fetchUtil("/totalStoreSales", data => {
      const labels = data.map(x=>x.storeName);
      const values = data.map(x=>x.totalSales);

      new Chart($("#storeSalesTop5Chart"),{
        type:"bar",
        data:{ labels, datasets:[{ label:"매출금액", data:values }] },
        options:{ indexAxis:"y" }
      });
    });
  }


  /* === 메뉴 비중 === */
  function loadMenuRatio(){
    fetchUtil("/menuRatio", data => {
      data.sort((a,b)=>b.salesAmount-a.salesAmount);

      const top5 = data.slice(0,5);
      const etc = data.slice(5);
      const etcTotal = etc.reduce((s,x)=>s+x.salesAmount,0);

      const labels = top5.map(x=>x.menuName);
      const values = top5.map(x=>x.salesAmount);

      if(etcTotal>0){ labels.push("기타"); values.push(etcTotal); }

      new Chart($("#menuCountChart"),{
        type:"doughnut",
        data:{ labels, datasets:[{ data:values }] },
        plugins:[ChartDataLabels],
        options:{
          plugins:{
            legend:{ display:false },
            datalabels:{
              color:"#000",
              formatter:(value,ctx)=>{
                const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                return (value/total*100).toFixed(1)+"%";
              }
            }
          }
        }
      });
    });
  }


  /* === 초기 실행 === */
  $(document).ready(function(){

    showChart();

    // 기본 선택: 일별(day)
    $("#day").prop("checked", true);
    updatePeriodInputs("day");

    // 이번달 1일 ~ 어제
    const today = new Date();
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    function toDate(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    const s = toDate(monthStart);
    const e = toDate(yesterday);

    $("#startInput").val(s);
    $("#endInput").val(e);

    // 메인 차트 로딩
    loadTrend("day", s, e);

    // TOP5 + 메뉴비중
    loadTop5();
    loadMenuRatio();
  });

</script>

</body>
</html>
