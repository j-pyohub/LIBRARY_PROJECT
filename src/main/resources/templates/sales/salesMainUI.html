<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>매출관리 SPA (본사)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- fetchUtil -->
    <script>
        function fetchUtil(url, action){
            fetch(url)
                .then(res => res.json())
                .then(action)
                .catch(err => console.error("에러:", err));
        }
    </script>

    <style>
        body { background-color:#fdfdfd; }
        .layout-container { max-width:1500px; margin:0 auto; }
        .w-150 { width:150px; }
        .w-120 { width:120px; }
        .kpi-card { background:#fff; border:1px solid #ccc; border-radius:10px; padding:18px; text-align:center; }
        .kpi-title { font-size:14px; }
        .kpi-value { font-size:22px; font-weight:600; }
        .section-box { background:#fff; border:1px solid #ddd; border-radius:10px; padding:20px; }
        #listPage { display:none; }
    </style>
</head>

<body class="p-2">

<div class="border border-primary p-2 layout-container">

    <!-- 보기 버튼 -->
    <div class="mt-3 px-2">
        <div class="d-flex align-items-center mb-2">
            <span class="me-2">보기</span>
            <div class="btn-group">
                <button id="chartBtn" class="btn btn-warning btn-sm">차트</button>
                <button id="listBtn" class="btn btn-outline-secondary btn-sm">목록</button>
            </div>
        </div>
    </div>

    <!-- ============================
         CHART PAGE
    ============================ -->
    <div id="chartPage">

        <!-- 기간/조회 -->
        <div class="d-flex align-items-center flex-wrap gap-3 mb-3 px-2">

            <!-- 라디오 -->
            <div>
                <label class="form-check form-check-inline">
                    <input type="radio" name="period" id="day" class="form-check-input">
                    <span>일별</span>
                </label>
                <label class="form-check form-check-inline">
                    <input type="radio" name="period" id="week" class="form-check-input">
                    <span>주별</span>
                </label>
                <label class="form-check form-check-inline">
                    <input type="radio" name="period" id="month" class="form-check-input" checked>
                    <span>월별</span>
                </label>
                <label class="form-check form-check-inline">
                    <input type="radio" name="period" id="year" class="form-check-input">
                    <span>연별</span>
                </label>
            </div>

            <!-- 조회기간 -->
            <div class="d-flex align-items-center gap-2">
                <span class="fw-semibold">조회기간</span>

                <div id="periodInputs" class="d-flex align-items-center gap-2">
                    <input id="startInput" type="month" class="form-control form-control-sm w-150">
                    <span>~</span>
                    <input id="endInput" type="month" class="form-control form-control-sm w-150">
                </div>

                <button id="getSalesBtn" class="btn btn-primary btn-sm">조회</button>
            </div>
        </div>

        <!-- KPI -->
        <div class="row g-3 mb-3 px-2">
            <div class="col-md-3"><div class="kpi-card"><div class="kpi-title">전체 매출</div><div class="kpi-value" id="kpi-totalSales"></div></div></div>
            <div class="col-md-3"><div class="kpi-card"><div class="kpi-title">총 판매 수량</div><div class="kpi-value" id="kpi-totalMenu"></div></div></div>
            <div class="col-md-3"><div class="kpi-card"><div class="kpi-title">평균 직영점 매출</div><div class="kpi-value" id="kpi-avgStore"></div></div></div>
            <div class="col-md-3"><div class="kpi-card"><div class="kpi-title">전주 대비 매출 증가</div><div class="kpi-value" id="kpi-growth"></div></div></div>
        </div>

        <!-- 메인 차트 -->
        <div class="section-box mx-2 mb-4">
            <h6 class="fw-bold mb-3">전체 매출 추이</h6>
            <canvas id="mainChart" height="90"></canvas>
        </div>

        <!-- TOP5 & 메뉴 비중 -->
        <div class="row g-3 mb-3 px-2">

            <div class="col-md-6">
                <div class="section-box">
                    <h6 class="fw-bold mb-3">최근 30일 지점별 매출 TOP 5</h6>
                    <canvas id="storeSalesTop5Chart" height="130"></canvas>
                </div>
            </div>

            <div class="col-md-6">
                <div class="section-box">
                    <h6 class="fw-bold mb-3">최근 30일 메뉴별 매출 비중</h6>
                    <canvas id="menuCountChart" height="130"></canvas>
                </div>
            </div>

        </div>

    </div> <!-- chartPage end -->

</div> <!-- layout end -->


<script>
    /* =============================
            보기 버튼
    ============================= */
    function updateModeButtons(mode){
        $("#chartBtn").toggleClass("btn-warning", mode === "chart")
            .toggleClass("btn-outline-secondary", mode !== "chart");
        $("#listBtn").toggleClass("btn-warning", mode === "list")
            .toggleClass("btn-outline-secondary", mode !== "list");
    }
    function showChart(){ $("#chartPage").show(); $("#listPage").hide(); updateModeButtons("chart"); }
    function showList(){ $("#chartPage").hide(); $("#listPage").show(); updateModeButtons("list"); }
    $("#chartBtn").on("click", showChart);
    $("#listBtn").on("click", showList);

    /* =============================
            조회 INPUT 변경
    ============================= */
    function updatePeriodInputs(type){
        const box = $("#periodInputs");

        if(type === "day"){
            box.html(`
            <input id="startInput" type="date" class="form-control form-control-sm w-150">
            <span>~</span>
            <input id="endInput" type="date" class="form-control form-control-sm w-150">
        `);
        } else if(type === "week"){
            box.html(`
            <input id="startInput" type="week" class="form-control form-control-sm w-150">
            <span>~</span>
            <input id="endInput" type="week" class="form-control form-control-sm w-150">
        `);
        } else if(type === "month"){
            box.html(`
            <input id="startInput" type="month" class="form-control form-control-sm w-150">
            <span>~</span>
            <input id="endInput" type="month" class="form-control form-control-sm w-150">
        `);
        } else {
            box.html(`
            <input id="startInput" type="number" class="form-control form-control-sm w-120" placeholder="연도 입력">
            <span>~</span>
            <input id="endInput" type="number" class="form-control form-control-sm w-120" placeholder="연도 입력">
        `);
        }
    }
    $("input[name='period']").on("change", function(){
        updatePeriodInputs($(this).attr("id"));
    });

    /* =============================
            메인 차트
    ============================= */
    let mainChart;

    function createMainChart(labels, values){
        const ctx = $("#mainChart")[0].getContext("2d");

        if(mainChart){ mainChart.destroy(); }

        mainChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "매출액",
                    data: values,
                    borderColor: "#007bff",
                    backgroundColor: "rgba(0,123,255,0.15)",
                    borderWidth: 2,
                    fill: true
                }]
            }
        });
    }

    $("#getSalesBtn").on("click", function(){
        const type = $("input[name='period']:checked").attr("id");
        const s = $("#startInput").val();
        const e = $("#endInput").val();

        if(!s || !e){
            alert("조회기간을 입력하세요.");
            return;
        }

        const url = `/salesChart?startDate=${s}&endDate=${e}&type=${type}`;

        fetchUtil(url, data => {
            createMainChart(data.labels, data.values);
            loadKPI(type, s, e);
        });
    });

    /* =============================
            TOP5
    ============================= */
    let top5Chart;

    function createTop5Chart(labels, values){
        const ctx = $("#storeSalesTop5Chart")[0].getContext("2d");

        if(top5Chart){ top5Chart.destroy(); }

        top5Chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "매출금액",
                    data: values,
                    backgroundColor: ["#0d6efd","#6f42c1","#d63384","#fd7e14","#198754"]
                }]
            },
            options:{ indexAxis:"y" }
        });
    }

    function loadTop5Chart(){
        fetchUtil("/totalStoreSales", data => {
            createTop5Chart(
                data.map(x => x.storeName),
                data.map(x => x.totalSales)
            );
        });
    }

    /* =============================
            메뉴 비중
    ============================= */
    let menuChart;

    function createMenuRatioChart(labels, values){
        const ctx = $("#menuCountChart")[0].getContext("2d");

        if(menuChart){ menuChart.destroy(); }

        const baseColors = ["#ff6384","#36a2eb","#ffcd56","#4bc0c0","#9966ff"];

        let colors = labels.map((_, i) => i < 5 ? baseColors[i] : "#999999");

        menuChart = new Chart(ctx, {
            type: "doughnut",
            data: { labels, datasets:[{ data:values, backgroundColor: colors }] },
            plugins: [ChartDataLabels],
            options: {
                plugins: {
                    legend: { display:false },
                    datalabels: {
                        color:"#000",
                        font:{ size:12, weight:"bold" },
                        formatter: (value, context) => {
                            const label = context.chart.data.labels[context.dataIndex];
                            const total = context.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                            const percent = (value/total*100).toFixed(1);
                            return label + "\n" + percent + "%";
                        }
                    }
                }
            }
        });
    }

    function loadMenuRatio(){
        fetchUtil("/menuRatio", data => {

            data.sort((a, b) => b.salesAmount - a.salesAmount);
            const top5 = data.slice(0, 5);
            const etc = data.slice(5);
            const etcTotal = etc.reduce((sum, x) => sum + x.salesAmount, 0);

            const labels = top5.map(x => x.menuName);
            const values = top5.map(x => x.salesAmount);

            if(etcTotal > 0){
                labels.push("기타");
                values.push(etcTotal);
            }

            createMenuRatioChart(labels, values);
        });
    }

    /* =============================
            KPI
    ============================= */
    function loadKPI(type, start, end){
        const url = `/KPI?type=${type}&startDate=${start}&endDate=${end}`;

        fetchUtil(url, data => {
            $("#kpi-totalSales").text(data.totalSales.toLocaleString());
            $("#kpi-totalMenu").text(data.totalMenuCount.toLocaleString());
            $("#kpi-avgStore").text(data.avgStoreSales.toLocaleString());
            $("#kpi-growth").text(data.growthRate.toFixed(1) + "%");
        });
    }

    /* =============================
            초기 세팅
    ============================= */
    $(document).ready(function(){

        showChart();

        /* 초기값: 이번달 1일 ~ 어제(day 모드) */
        $("#day").prop("checked", true);
        updatePeriodInputs("day");

        const today = new Date();
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        function toDate(d){
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            return `${yyyy}-${mm}-${dd}`;
        }

        const s = toDate(monthStart);
        const e = toDate(yesterday);

        $("#startInput").val(s);
        $("#endInput").val(e);

        /* 초기 메인차트 */
        fetchUtil(`/salesChart?startDate=${s}&endDate=${e}&type=day`, data => {
            createMainChart(data.labels, data.values);
        });

        /* 초기 KPI */
        loadKPI("day", s, e);

        /* 고정 차트 */
        loadTop5Chart();
        loadMenuRatio();
    });
</script>

</body>
</html>
